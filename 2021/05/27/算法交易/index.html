<!DOCTYPE html>


<html lang="zh-CN">
  

    <head>
      <meta charset="utf-8" />
       
      <meta name="keywords" content="hack, quant, fight" />
       
      <meta name="description" content="见路不走" />
      
      <meta
        name="viewport"
        content="width=device-width, initial-scale=1, maximum-scale=1"
      />
      <title>算法交易（Algorithmic Trading） |  Sandy&#39;s Blog</title>
  <meta name="generator" content="hexo-theme-ayer">
      
      <link rel="shortcut icon" href="/favicon.ico" />
       
<link rel="stylesheet" href="/dist/main.css">

      <link
        rel="stylesheet"
        href="https://cdn.jsdelivr.net/gh/Shen-Yu/cdn/css/remixicon.min.css"
      />
      
<link rel="stylesheet" href="/css/custom.css">
 
      <script src="https://cdn.jsdelivr.net/npm/pace-js@1.0.2/pace.min.js"></script>
       
 

      <!-- mermaid -->
      
    </head>
  </html>
</html>


<body>
  <div id="app">
    
      <canvas class="fireworks"></canvas>
      <style>
        .fireworks {
          position: fixed;
          left: 0;
          top: 0;
          z-index: 99999;
          pointer-events: none;
        }
      </style>
      
      
    <main class="content on">
      <section class="outer">
  <article
  id="post-算法交易"
  class="article article-type-post"
  itemscope
  itemprop="blogPost"
  data-scroll-reveal
>
  <div class="article-inner">
    
    <header class="article-header">
       
<h1 class="article-title sea-center" style="border-left:0" itemprop="name">
  算法交易（Algorithmic Trading）
</h1>
 

      
    </header>
     
    <div class="article-meta">
      <a href="/2021/05/27/%E7%AE%97%E6%B3%95%E4%BA%A4%E6%98%93/" class="article-date">
  <time datetime="2021-05-27T14:12:52.000Z" itemprop="datePublished">2021-05-27</time>
</a> 
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E9%87%91%E8%9E%8D/">金融</a>
  </div>
  
<div class="word_count">
    <span class="post-time">
        <span class="post-meta-item-icon">
            <i class="ri-quill-pen-line"></i>
            <span class="post-meta-item-text"> 字数统计:</span>
            <span class="post-count">7.2k</span>
        </span>
    </span>

    <span class="post-time">
        &nbsp; | &nbsp;
        <span class="post-meta-item-icon">
            <i class="ri-book-open-line"></i>
            <span class="post-meta-item-text"> 阅读时长≈</span>
            <span class="post-count">33 分钟</span>
        </span>
    </span>
</div>
 
    </div>
      
    <div class="tocbot"></div>




  
    <div class="article-entry" itemprop="articleBody">
       
  <h2 id="0x00-环境准备"><a href="#0x00-环境准备" class="headerlink" title="0x00 环境准备"></a>0x00 环境准备</h2><ol>
<li><p>系统版本：Windows 7 sp1 x64</p>
</li>
<li><p>Python版本：3.8.8 （3.9 以上不支持在win7上运行）</p>
</li>
<li><p>Python包： <code>pip install numpy pandas matplotlib mplfinance jupyter tushare</code></p>
</li>
<li><p>在线平台：<a target="_blank" rel="noopener" href="https://www.joinquant.com/">聚宽</a></p>
</li>
<li><p>量化概念（算法交易）</p>
<table>
<thead>
<tr>
<th>策略</th>
<th>解释</th>
</tr>
</thead>
<tbody><tr>
<td>选股</td>
<td></td>
</tr>
<tr>
<td>择时</td>
<td></td>
</tr>
<tr>
<td>仓位管理</td>
<td>多只股票的资金分配、空仓率</td>
</tr>
<tr>
<td>止盈止损</td>
<td></td>
</tr>
</tbody></table>
</li>
</ol>
<p><img src="https://i.loli.net/2021/05/27/42GYeJhXZi8s5PQ.png" alt="mind.PNG"></p>
<hr>
<h2 id="0x01-数据下载"><a href="#0x01-数据下载" class="headerlink" title="0x01 数据下载"></a>0x01 数据下载</h2><h3 id="1-1-tushare包"><a href="#1-1-tushare包" class="headerlink" title="1.1 tushare包"></a>1.1 tushare包</h3><h4 id="1-1-1-价格与成交量"><a href="#1-1-1-价格与成交量" class="headerlink" title="1.1.1 价格与成交量"></a>1.1.1 价格与成交量</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 开盘价，收盘价，最高价，最低价，成交量</span></span><br><span class="line"><span class="keyword">import</span> tushare <span class="keyword">as</span> ts</span><br><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"></span><br><span class="line">df = ts.get_k_data(<span class="string">&#x27;600519&#x27;</span>, start=<span class="string">&#x27;1988-01-01&#x27;</span>) <span class="comment">#茅台股票代码为600519</span></span><br><span class="line">df.to_csv(<span class="string">&#x27;600519_k_total.csv&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p><img src="https://i.loli.net/2021/05/27/UtO82QVvXlnarfD.png" alt="csv.PNG"></p>
<p><strong>注意：</strong></p>
<ol>
<li><code>ktype=</code> 默认取日K线，最高频率为5分钟K线，1分钟高频交易数据无法拿到。</li>
<li><code>autype=</code>默认为前复权。复权是相对于除权而言，所谓除权是上市公司分红派息、送股配股时需要把相关权益从当前股价中扣除，从而造成股价的断崖式下跌。复权就是在股票除权后把股价恢复到除权之前，不然会影响投资判断。前复权就是修正除权前的价格，向之后的价格对齐；后复权就是修正除权后的价格，向之前的价格对齐。</li>
</ol>
<h4 id="1-1-2-其他"><a href="#1-1-2-其他" class="headerlink" title="1.1.2 其他"></a>1.1.2 其他</h4><h5 id="1-1-2-1-换手率（turnover）-ts-get-hist-data"><a href="#1-1-2-1-换手率（turnover）-ts-get-hist-data" class="headerlink" title="1.1.2.1 换手率（turnover） ts.get_hist_data()"></a>1.1.2.1 换手率（turnover） <code>ts.get_hist_data()</code></h5><p>无法指定起止日期，只能拿到近三年的数据。</p>
<h5 id="1-1-2-2-实时分时图（买卖五档的价格和笔数）ts-get-realtime-quotes"><a href="#1-1-2-2-实时分时图（买卖五档的价格和笔数）ts-get-realtime-quotes" class="headerlink" title="1.1.2.2 实时分时图（买卖五档的价格和笔数）ts.get_realtime_quotes()"></a>1.1.2.2 实时分时图（买卖五档的价格和笔数）<code>ts.get_realtime_quotes()</code></h5><p><img src="https://i.loli.net/2021/05/27/dBmaQhUqv3MA4by.png" alt="jp44.PNG"></p>
<h5 id="1-1-2-3-当日分笔成交-ts-get-today-ticks"><a href="#1-1-2-3-当日分笔成交-ts-get-today-ticks" class="headerlink" title="1.1.2.3 当日分笔成交 ts.get_today_ticks()"></a>1.1.2.3 当日分笔成交 <code>ts.get_today_ticks()</code></h5><p><img src="https://i.loli.net/2021/05/27/ha4j8L27lGKWgNq.png" alt="jp55.PNG"></p>
<h5 id="1-1-2-4-A股所有股票数据-ts-get-today-all"><a href="#1-1-2-4-A股所有股票数据-ts-get-today-all" class="headerlink" title="1.1.2.4 A股所有股票数据 ts.get_today_all()"></a>1.1.2.4 A股所有股票数据 <code>ts.get_today_all()</code></h5><p><img src="https://i.loli.net/2021/05/27/6m3wnFuXa45pQAf.png" alt="jp6.PNG"></p>
<h5 id="1-1-2-5-行情指数列表-ts-get-index"><a href="#1-1-2-5-行情指数列表-ts-get-index" class="headerlink" title="1.1.2.5 行情指数列表 ts.get_index()"></a>1.1.2.5 行情指数列表 <code>ts.get_index()</code></h5><p><img src="https://i.loli.net/2021/05/27/O4PJTIvEDcdZheY.png" alt="index.PNG"></p>
<hr>
<h2 id="0x02-策略收集"><a href="#0x02-策略收集" class="headerlink" title="0x02 策略收集"></a>0x02 策略收集</h2><h3 id="2-1-定投策略"><a href="#2-1-定投策略" class="headerlink" title="2.1 定投策略"></a>2.1 定投策略</h3><p>（一）本地实现</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#策略1：自2010年1月1日，每月第一个交易日买入1手茅台，每年最后的交易日卖出所有股票</span></span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line"><span class="keyword">import</span> mplfinance <span class="keyword">as</span> mpf</span><br><span class="line"><span class="keyword">import</span> tushare <span class="keyword">as</span> ts</span><br><span class="line"></span><br><span class="line"><span class="comment">#数据获取</span></span><br><span class="line">df = ts.get_k_data(<span class="string">&#x27;600519&#x27;</span>, start=<span class="string">&#x27;1988-01-01&#x27;</span>)</span><br><span class="line">df.to_csv(<span class="string">&#x27;600519.csv&#x27;</span>)</span><br><span class="line">df = pd.read_csv(<span class="string">&#x27;600519.csv&#x27;</span>, index_col=<span class="string">&#x27;date&#x27;</span>, parse_dates=[<span class="string">&#x27;date&#x27;</span>])[[<span class="string">&#x27;open&#x27;</span>, <span class="string">&#x27;close&#x27;</span>,<span class="string">&#x27;high&#x27;</span>,<span class="string">&#x27;low&#x27;</span>]] <span class="comment">#只保留四列基本数据		</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#数据处理</span></span><br><span class="line">df = df[<span class="string">&#x27;2010-01-01&#x27;</span>: <span class="string">&#x27;2020-12-31&#x27;</span>] <span class="comment">#剔除非整年数据</span></span><br><span class="line">df_monthly = df.resample(<span class="string">&#x27;M&#x27;</span>).first() <span class="comment">#每月第一个交易日数据</span></span><br><span class="line">df_yearly = df.resample(<span class="string">&#x27;A&#x27;</span>).last() <span class="comment">#每年最后一个交易日数据</span></span><br><span class="line"><span class="comment">#Rk: index显示不对，不影响计算</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#计算收益</span></span><br><span class="line">cost_money = df_monthly.<span class="built_in">sum</span>()[<span class="string">&#x27;open&#x27;</span>] * <span class="number">100</span> <span class="comment"># 每月第一个交易日以开盘价买入一手</span></span><br><span class="line">earn_money = df_yearly.<span class="built_in">sum</span>()[<span class="string">&#x27;close&#x27;</span>] * <span class="number">100</span> * <span class="number">12</span> <span class="comment">#每月最后一个交易日以收盘价把当年12手股票卖掉</span></span><br><span class="line">total = earn_money - cost_money <span class="comment">#总收益</span></span><br></pre></td></tr></table></figure>

<p>（二）聚宽实现</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 策略1：定投</span></span><br><span class="line"><span class="comment"># 标的：贵州茅台</span></span><br><span class="line"><span class="comment"># 每月第一个交易日买入1手茅台，每年最后一个交易日卖出</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> jqdata <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> datetime</span><br><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">initialize</span>(<span class="params">context</span>):</span></span><br><span class="line">    <span class="comment"># 基本设置</span></span><br><span class="line">    run_daily(period, time=<span class="string">&#x27;every_bar&#x27;</span>) <span class="comment">#指定每天跑什么函数（period）</span></span><br><span class="line">    set_benchmark(<span class="string">&#x27;000300.XSHG&#x27;</span>) <span class="comment"># 设置比较基准（红线）</span></span><br><span class="line">    set_option(<span class="string">&#x27;use_real_price&#x27;</span>, <span class="literal">True</span>) <span class="comment"># 开启动态复权模式(真实价格)</span></span><br><span class="line">    set_order_cost(OrderCost(close_tax=<span class="number">0.001</span>, open_commission=<span class="number">0.0003</span>, close_commission=<span class="number">0.0003</span>,</span><br><span class="line">                            min_commission=<span class="number">5</span>), <span class="built_in">type</span>=<span class="string">&#x27;stock&#x27;</span>) <span class="comment">#</span></span><br><span class="line">    <span class="comment"># 标的选择</span></span><br><span class="line">    g.security = <span class="string">&#x27;600519.XSHG&#x27;</span> <span class="comment"># 选定交易股票为茅台</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 交易日期处理</span></span><br><span class="line">    g.tradeDaysTotal = get_trade_days(start_date=<span class="string">&quot;1988-01-01&quot;</span>) <span class="comment">#获取全部交易日期; type = numpy.ndarray [datetime.date,...]</span></span><br><span class="line">    g.df_dateTimeIndex = pd.to_datetime(g.tradeDaysTotal) <span class="comment">#时间索引</span></span><br><span class="line">    g.daySeries = pd.Series(g.tradeDaysTotal, index = g.df_dateTimeIndex)[<span class="string">&#x27;2010-01-01&#x27;</span>: <span class="string">&#x27;2020-12-31&#x27;</span>] <span class="comment">#创建Series对象，剔除非整年数据</span></span><br><span class="line">    g.day_monthly = g.daySeries.resample(<span class="string">&#x27;M&#x27;</span>).first().tolist() <span class="comment">#每月第一个交易日; type = list[datetime.date, ...]</span></span><br><span class="line">    g.day_yearly = g.daySeries.resample(<span class="string">&#x27;A&#x27;</span>).last().tolist() <span class="comment">#每年最后一个交易日</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">#验证日期处理是否正确</span></span><br><span class="line">    <span class="comment">#if datetime.date(*map(int, &#x27;2005-02-01&#x27;.split(&#x27;-&#x27;))) in g.day_monthly:</span></span><br><span class="line">    <span class="comment">#    print(&#x27;ok&#x27;)</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">period</span>(<span class="params">context</span>):</span></span><br><span class="line">    <span class="comment">#交易日期处理</span></span><br><span class="line">    <span class="comment">#now_date = datetime.date.today() #获取程序运行的实际日期; type = datetime.date</span></span><br><span class="line">    current_date = get_current_data()[g.security].date <span class="comment">#获取当前日期</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 交易</span></span><br><span class="line">    <span class="comment"># 当前时间为年度最后一个交易日</span></span><br><span class="line">    <span class="keyword">if</span> current_date <span class="keyword">in</span> g.day_yearly:</span><br><span class="line">        order_target(g.security, <span class="number">0</span>) <span class="comment">#清仓</span></span><br><span class="line">    <span class="comment"># 当前是月度第一个交易日</span></span><br><span class="line">    <span class="keyword">if</span> current_date <span class="keyword">in</span> g.day_monthly:</span><br><span class="line">        order(g.security, <span class="number">100</span>) <span class="comment">#买入1手茅台</span></span><br></pre></td></tr></table></figure>


<p><img src="https://i.loli.net/2021/05/27/km6gxORoibSAdyU.png" alt="strategy1result.PNG"></p>
<blockquote>
<p><code>get_current_data()</code>API文档并无<code>date</code>属性说明，全凭自己推测出来的。</p>
</blockquote>
<h3 id="2-2-双均线策略"><a href="#2-2-双均线策略" class="headerlink" title="2.2 双均线策略"></a>2.2 双均线策略</h3><p>（一）本地实现</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#策略2：金叉买入，死叉卖出（以5日均线和10日均线代表短线和中线）</span></span><br><span class="line"><span class="comment">#import及数据获取代码同上</span></span><br><span class="line">df[<span class="string">&#x27;MA_5&#x27;</span>] = df[<span class="string">&#x27;close&#x27;</span>].rolling(<span class="number">5</span>).mean() <span class="comment">#5日均线</span></span><br><span class="line">df[<span class="string">&#x27;MA_60&#x27;</span>] = df[<span class="string">&#x27;close&#x27;</span>].rolling(<span class="number">10</span>).mean() <span class="comment">#10日均线</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#分析输出所有金叉日期和死叉日期</span></span><br><span class="line">df = df.dropna() <span class="comment">#删除含有NaN的全部行</span></span><br><span class="line">sr1 = df[<span class="string">&#x27;MA_5&#x27;</span>] &gt;= df[<span class="string">&#x27;MA_10&#x27;</span>]</span><br><span class="line">sr2 = df[<span class="string">&#x27;MA_5&#x27;</span>] &lt; df[<span class="string">&#x27;MA_10&#x27;</span>]</span><br><span class="line">gold_cross = df[sr1 &amp; sr2.shift(<span class="number">1</span>)].index <span class="comment">#当日MA5&gt;=MA10，且前日MA5&lt;ma10.则为金叉</span></span><br><span class="line">dead_cross = df[sr2 &amp; sr1.shift(<span class="number">1</span>)].index <span class="comment">#当日MA5&lt;MA10，且前日MA5&gt;=ma10.则为死叉</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#计算收益</span></span><br><span class="line"><span class="comment">#假设：假如从2010年1月1日开始，初始资金为100000元，金叉尽量买入，死叉全部卖出，则至今收益多少？</span></span><br><span class="line">first_money = <span class="number">100000</span></span><br><span class="line">money = first_money    <span class="comment"># 持有的资金</span></span><br><span class="line">hold = <span class="number">0</span>               <span class="comment"># 持有的股票</span></span><br><span class="line">sr1 = pd.Series(<span class="number">1</span>, index=gold_cross) <span class="comment"># 金叉点填1</span></span><br><span class="line">sr2 = pd.Series(<span class="number">0</span>, index=dead_cross) <span class="comment"># 死叉点填0</span></span><br><span class="line"></span><br><span class="line">sr = sr1.append(sr2).sort_index()    <span class="comment"># 将两个表合并，并按时间排序</span></span><br><span class="line">sr = sr[<span class="string">&#x27;2010-01-01&#x27;</span>:]           <span class="comment"># 从2010年1月1日开始</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="built_in">len</span>(sr)):</span><br><span class="line">    p = df[<span class="string">&#x27;open&#x27;</span>][sr.index[i]]      <span class="comment"># 当天的开盘价</span></span><br><span class="line">    <span class="keyword">if</span> sr.iloc[i] == <span class="number">1</span>:</span><br><span class="line">        <span class="comment"># 金叉</span></span><br><span class="line">        buy = money // (<span class="number">100</span> * p)   <span class="comment"># 买多少手</span></span><br><span class="line">        hold += buy * <span class="number">100</span></span><br><span class="line">        money -= buy * <span class="number">100</span> * p</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="comment"># 死叉</span></span><br><span class="line">        money += hold * p</span><br><span class="line">        hold = <span class="number">0</span>    <span class="comment"># 持有股票重置为0</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 计算最后一天股票市值加上持有的资金</span></span><br><span class="line">p = df[<span class="string">&#x27;open&#x27;</span>][-<span class="number">1</span>] <span class="comment">#最后一天开盘价</span></span><br><span class="line">now_money = hold * p + money</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;当前持有资产总额:&#x27;</span>, now_money)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;盈亏情况（持有股票+现金）:&#x27;</span>, now_money - first_money)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;持有资金数（净盈亏）：&#x27;</span>, money-first_money)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;持有股票数：&#x27;</span>, hold)</span><br></pre></td></tr></table></figure>

<p>（二）聚宽实现</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 策略2：双均线（金叉买入死叉卖出）</span></span><br><span class="line"><span class="comment"># 标的：贵州茅台</span></span><br><span class="line"><span class="comment"># 金叉买入：5日均线 &gt; 10日均线 且不持仓</span></span><br><span class="line"><span class="comment"># 死叉卖出：5日均线 &lt; 10日均线 且持仓</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">initialize</span>(<span class="params">context</span>):</span></span><br><span class="line">    <span class="comment"># 基本设置</span></span><br><span class="line">    run_daily(period, time=<span class="string">&#x27;every_bar&#x27;</span>) <span class="comment">#指定每天跑什么函数（period）</span></span><br><span class="line">    set_benchmark(<span class="string">&#x27;000300.XSHG&#x27;</span>) <span class="comment"># 设置比较基准（红线）</span></span><br><span class="line">    set_option(<span class="string">&#x27;use_real_price&#x27;</span>, <span class="literal">True</span>) <span class="comment"># 开启动态复权模式(真实价格)</span></span><br><span class="line">    set_order_cost(OrderCost(close_tax=<span class="number">0.001</span>, open_commission=<span class="number">0.0003</span>, close_commission=<span class="number">0.0003</span>,</span><br><span class="line">                            min_commission=<span class="number">5</span>), <span class="built_in">type</span>=<span class="string">&#x27;stock&#x27;</span>) <span class="comment">#</span></span><br><span class="line">    <span class="comment"># 标的选择</span></span><br><span class="line">    g.security = [<span class="string">&#x27;600519.XSHG&#x27;</span>] <span class="comment"># 选定交易股票为茅台</span></span><br><span class="line">    g.p1 = <span class="number">5</span></span><br><span class="line">    g.p2 = <span class="number">10</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">period</span>(<span class="params">context</span>):</span></span><br><span class="line">    <span class="keyword">for</span> stock <span class="keyword">in</span> g.security:</span><br><span class="line">        df = attribute_history(stock, g.p2) <span class="comment"># 获取股票历史数据（往前数10天的数据）</span></span><br><span class="line">        ma10 = df[<span class="string">&#x27;close&#x27;</span>].mean()</span><br><span class="line">        ma5  = df[<span class="string">&#x27;close&#x27;</span>][-<span class="number">5</span>:].mean()</span><br><span class="line"></span><br><span class="line">        <span class="comment">#死叉：</span></span><br><span class="line">        <span class="keyword">if</span> ma10 &gt; ma5 <span class="keyword">and</span> stock <span class="keyword">in</span> context.portfolio.positions:</span><br><span class="line">            order_target(stock, <span class="number">0</span>) <span class="comment">#清仓</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">#金叉：</span></span><br><span class="line">        <span class="keyword">if</span> ma10 &lt; ma5 <span class="keyword">and</span> stock <span class="keyword">not</span> <span class="keyword">in</span> context.portfolio.positions:</span><br><span class="line">            order_value(stock, context.portfolio.available_cash * <span class="number">0.8</span>) <span class="comment"># 买入80%仓位</span></span><br></pre></td></tr></table></figure>


<p><img src="https://i.loli.net/2021/05/27/SCJ3846fNa2ARne.png" alt="strategy2result.PNG"></p>
<blockquote>
<p>聚宽实现双均线策略时，均线计算略有问题，当天5日K线应包含本日数据，但attribute_history(stock, 5)不包含本日数据。</p>
</blockquote>
<h3 id="2-3-低股价策略"><a href="#2-3-低股价策略" class="headerlink" title="2.3 低股价策略"></a>2.3 低股价策略</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 策略3：低股价策略（单因子选股）</span></span><br><span class="line"><span class="comment"># 标的：沪深300所有成分股</span></span><br><span class="line"><span class="comment"># 如果当前股价&lt; 10元 且当前不持仓，则买入；</span></span><br><span class="line"><span class="comment"># 如果当前估计比买入时上涨了25%，则清仓止盈；</span></span><br><span class="line"><span class="comment"># 如果当前估计比买入时下跌了10%，则清仓止损。</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> jqdata <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="comment"># 初始化框架</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">initialize</span>(<span class="params">context</span>):</span></span><br><span class="line">    run_daily(period, time=<span class="string">&#x27;every_bar&#x27;</span>) <span class="comment">#指定每天跑什么函数（period）</span></span><br><span class="line">    set_benchmark(<span class="string">&#x27;000300.XSHG&#x27;</span>) <span class="comment"># 设置比较基准为沪深300指数（红线）</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">#g.security = &#x27;600519.XSHE&#x27; # 选定交易股票为茅台</span></span><br><span class="line">    g.security = get_index_stocks(<span class="string">&#x27;000300.XSHG&#x27;</span>) <span class="comment"># 选定交易标的为沪深300股票池(list)</span></span><br><span class="line">    set_option(<span class="string">&#x27;use_real_price&#x27;</span>, <span class="literal">True</span>) <span class="comment"># 开启动态复权模式(真实价格)</span></span><br><span class="line">    set_order_cost(OrderCost(close_tax=<span class="number">0.001</span>, open_commission=<span class="number">0.0003</span>, close_commission=<span class="number">0.0003</span>,</span><br><span class="line">                            min_commission=<span class="number">5</span>), <span class="built_in">type</span>=<span class="string">&#x27;stock&#x27;</span>) <span class="comment"># 设置佣金、印花税</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 循环框架（每个交易日都执行initialize函数）</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">period</span>(<span class="params">context</span>):</span></span><br><span class="line">    <span class="comment">#print(get_current_data()[&#x27;600519.XSHG&#x27;].day_open) # 获取茅台开盘价</span></span><br><span class="line">    <span class="comment">#print(attribute_history(&#x27;600519.XSHG&#x27;,5)) #获取5天的茅台数据  </span></span><br><span class="line">    <span class="comment">#order(&#x27;600519.XSHG&#x27;, 100) # 按股数下单（买1手茅台）</span></span><br><span class="line">    <span class="comment">#order_value(&#x27;600519.XSHG&#x27;, 200000) # 按价值下单（买20万的茅台）</span></span><br><span class="line">    </span><br><span class="line">    tobuy = []</span><br><span class="line">    <span class="keyword">for</span> stock <span class="keyword">in</span> g.security:</span><br><span class="line">        p = get_current_data()[stock].day_open <span class="comment"># 股价（开盘价）</span></span><br><span class="line">        amount = context.portfolio.positions[stock].total_amount <span class="comment"># 持仓信息</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">#找符合条件的股票</span></span><br><span class="line">        <span class="keyword">if</span> p &lt;= <span class="number">10.0</span> <span class="keyword">and</span> amount == <span class="number">0</span>:</span><br><span class="line">            tobuy.append(stock)</span><br><span class="line">    </span><br><span class="line">        <span class="comment">#卖（先卖后买） </span></span><br><span class="line">        cost = context.portfolio.positions[stock].avg_cost</span><br><span class="line">        <span class="keyword">if</span> amount &gt; <span class="number">0</span> <span class="keyword">and</span> p &gt;= cost * <span class="number">1.25</span>:</span><br><span class="line">            order_target(stock, <span class="number">0</span>) <span class="comment">#清仓止盈</span></span><br><span class="line">        <span class="keyword">if</span> amount &gt; <span class="number">0</span> <span class="keyword">and</span> p &lt;= cost * <span class="number">0.9</span>:</span><br><span class="line">            order_target(stock, <span class="number">0</span>) <span class="comment">#清仓止损</span></span><br><span class="line">            </span><br><span class="line">    <span class="comment">#买</span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(tobuy):</span><br><span class="line">        cash_per_stock = context.portfolio.available_cash / <span class="built_in">len</span>(tobuy)</span><br><span class="line">        <span class="keyword">for</span> stock <span class="keyword">in</span> tobuy:</span><br><span class="line">            order_value(stock, cash_per_stock)</span><br></pre></td></tr></table></figure>

<p><img src="https://i.loli.net/2021/05/27/JZUecEDtm8AIO49.png" alt="strategy3result.PNG"></p>
<ul>
<li>Q：持仓中达到止损线同时又满足买入条件怎么办？</li>
<li>A：该策略先把所有股票的开盘价跑一遍，上述类型股票由于amount&gt;0，不符合买入条件，故只卖不买，无矛盾。</li>
</ul>
<h3 id="2-4-小市值策略"><a href="#2-4-小市值策略" class="headerlink" title="2.4 小市值策略"></a>2.4 小市值策略</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 小市值策略（单因子选股）</span></span><br><span class="line"><span class="comment"># 标的：沪深300池</span></span><br><span class="line"><span class="comment"># 选取股票池中市值最小的N只股票</span></span><br><span class="line"><span class="comment"># 更新持仓：</span></span><br><span class="line"><span class="comment">#   1. 已有持仓中不在新列表的票清掉</span></span><br><span class="line"><span class="comment">#   2. 已有持仓在新列表中的票继续持有</span></span><br><span class="line"><span class="comment">#   3. 新列表中未持有的买入（资金平分）</span></span><br><span class="line"><span class="comment"># 更新时间： 每月第一个交易日</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">initialize</span>(<span class="params">context</span>):</span></span><br><span class="line">    <span class="comment"># 基本设置</span></span><br><span class="line">    set_benchmark(<span class="string">&#x27;000300.XSHG&#x27;</span>) <span class="comment"># 设置比较基准（红线）</span></span><br><span class="line">    set_option(<span class="string">&#x27;use_real_price&#x27;</span>, <span class="literal">True</span>) <span class="comment"># 开启动态复权模式(真实价格)</span></span><br><span class="line">    set_order_cost(OrderCost(close_tax=<span class="number">0.001</span>, open_commission=<span class="number">0.0003</span>, close_commission=<span class="number">0.0003</span>,</span><br><span class="line">                            min_commission=<span class="number">5</span>), <span class="built_in">type</span>=<span class="string">&#x27;stock&#x27;</span>) <span class="comment">#印花税、佣金</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 运行函数</span></span><br><span class="line">    <span class="comment">#run_daily(period, time=&#x27;every_bar&#x27;) #指定每天跑什么函数（period）</span></span><br><span class="line">    run_monthly(period, <span class="number">1</span>) <span class="comment"># 每月1一个交易日执行period函数</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 标的选择</span></span><br><span class="line">    g.security = get_index_stocks(<span class="string">&#x27;000300.XSHG&#x27;</span>) <span class="comment"># 选定股票池为沪深300</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 查市值</span></span><br><span class="line">    g.q  = query(valuation).<span class="built_in">filter</span>(valuation.code.in_(g.security)) <span class="comment">#市值存放在valuation表中</span></span><br><span class="line">    g.N = <span class="number">20</span> </span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">period</span>(<span class="params">context</span>):</span></span><br><span class="line">    df = get_fundamentals(g.q)[[<span class="string">&#x27;code&#x27;</span>, <span class="string">&#x27;market_cap&#x27;</span>]] <span class="comment">#取市值列表</span></span><br><span class="line">    df = df.sort_values(<span class="string">&#x27;market_cap&#x27;</span>).iloc[:g.N,:] <span class="comment">#市值升序排列（取前N个小市值票）</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 先列要持有哪些票</span></span><br><span class="line">    to_hold = df[<span class="string">&#x27;code&#x27;</span>].values</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 不在持有名单的票：卖掉</span></span><br><span class="line">    <span class="keyword">for</span> stock <span class="keyword">in</span> context.portfolio.positions:</span><br><span class="line">        <span class="keyword">if</span> stock <span class="keyword">not</span> <span class="keyword">in</span> to_hold:</span><br><span class="line">            order_target(stock, <span class="number">0</span>) <span class="comment">#清仓</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 要持有但是还没有买的票</span></span><br><span class="line">    to_buy = [stock <span class="keyword">for</span> stock <span class="keyword">in</span> to_hold <span class="keyword">if</span> stock <span class="keyword">not</span> <span class="keyword">in</span> context.portfolio.positions]</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 买入新持有的票</span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(to_buy) &gt;<span class="number">0</span>:</span><br><span class="line">        cash_per_stock = context.portfolio.available_cash / <span class="built_in">len</span>(to_buy) <span class="comment"># 资金平均分配</span></span><br><span class="line">        <span class="keyword">for</span> stock <span class="keyword">in</span> to_buy:</span><br><span class="line">            order_value(stock, cash_per_stock)</span><br></pre></td></tr></table></figure>


<p><img src="https://i.loli.net/2021/05/27/Z6f5IkayjA7w93o.png" alt="strategy4result.PNG"></p>
<p>注：进一步可以剔除股票池的ST股。</p>
<h3 id="2-5-多因子选股"><a href="#2-5-多因子选股" class="headerlink" title="2.5 多因子选股"></a>2.5 多因子选股</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 多因子选股</span></span><br><span class="line"><span class="comment"># 标的：沪深300池</span></span><br><span class="line"><span class="comment"># 因子：市值，ROE;</span></span><br><span class="line"><span class="comment"># 模型：评分 = 归一化（市值 - ROE），选择评分最大的后N只票</span></span><br><span class="line"><span class="comment"># 择时： 每月第一个交易日更新持仓</span></span><br><span class="line"><span class="comment"># 更新持仓：</span></span><br><span class="line"><span class="comment">#   1. 已有持仓中不在新列表的票清掉</span></span><br><span class="line"><span class="comment">#   2. 已有持仓在新列表中的票继续持有</span></span><br><span class="line"><span class="comment">#   3. 新列表中未持有的买入（资金平分）</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">initialize</span>(<span class="params">context</span>):</span></span><br><span class="line">    <span class="comment"># 基本设置</span></span><br><span class="line">    set_benchmark(<span class="string">&#x27;000300.XSHG&#x27;</span>) <span class="comment"># 设置比较基准（红线）</span></span><br><span class="line">    set_option(<span class="string">&#x27;use_real_price&#x27;</span>, <span class="literal">True</span>) <span class="comment"># 开启动态复权模式(真实价格)</span></span><br><span class="line">    set_order_cost(OrderCost(close_tax=<span class="number">0.001</span>, open_commission=<span class="number">0.0003</span>, close_commission=<span class="number">0.0003</span>,</span><br><span class="line">                            min_commission=<span class="number">5</span>), <span class="built_in">type</span>=<span class="string">&#x27;stock&#x27;</span>) <span class="comment">#印花税、佣金</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 运行函数</span></span><br><span class="line">    <span class="comment">#run_daily(period, time=&#x27;every_bar&#x27;) #指定每天跑什么函数（period）</span></span><br><span class="line">    run_monthly(period, <span class="number">1</span>) <span class="comment"># 每月1一个交易日执行period函数</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 标的选择</span></span><br><span class="line">    g.security = get_index_stocks(<span class="string">&#x27;000300.XSHG&#x27;</span>) <span class="comment"># 选定股票池为沪深300</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 查股票财务数据</span></span><br><span class="line">    g.q  = query(valuation, indicator).<span class="built_in">filter</span>(valuation.code.in_(g.security)) <span class="comment">#市值和ROE分别存放在valuation和indicator表中</span></span><br><span class="line">    g.N = <span class="number">20</span> </span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">period</span>(<span class="params">context</span>):</span></span><br><span class="line">    df = get_fundamentals(g.q)[[<span class="string">&#x27;code&#x27;</span>, <span class="string">&#x27;market_cap&#x27;</span>, <span class="string">&#x27;roe&#x27;</span>]] <span class="comment">#取市值和ROE数据</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">#数据归一化</span></span><br><span class="line">    df[<span class="string">&#x27;market_cap&#x27;</span>] = (df[<span class="string">&#x27;market_cap&#x27;</span>] - df[<span class="string">&#x27;market_cap&#x27;</span>].<span class="built_in">min</span>()) / (df[<span class="string">&#x27;market_cap&#x27;</span>].<span class="built_in">max</span>() - df[<span class="string">&#x27;market_cap&#x27;</span>].<span class="built_in">min</span>())</span><br><span class="line">    df[<span class="string">&#x27;roe&#x27;</span>] = (df[<span class="string">&#x27;roe&#x27;</span>] - df[<span class="string">&#x27;roe&#x27;</span>].<span class="built_in">min</span>()) / (df[<span class="string">&#x27;roe&#x27;</span>].<span class="built_in">max</span>() - df[<span class="string">&#x27;roe&#x27;</span>].<span class="built_in">min</span>())</span><br><span class="line">    </span><br><span class="line">    df[<span class="string">&#x27;score&#x27;</span>] = df[<span class="string">&#x27;roe&#x27;</span>] - df[<span class="string">&#x27;market_cap&#x27;</span>] <span class="comment">#评分模型</span></span><br><span class="line"></span><br><span class="line">    df = df.sort_values(<span class="string">&#x27;score&#x27;</span>).iloc[-g.N:,:] <span class="comment">#评分升序排列（取评分最大的后N个票）</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 先列要持有哪些票</span></span><br><span class="line">    to_hold = df[<span class="string">&#x27;code&#x27;</span>].values</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 不在持有名单的票：卖掉</span></span><br><span class="line">    <span class="keyword">for</span> stock <span class="keyword">in</span> context.portfolio.positions:</span><br><span class="line">        <span class="keyword">if</span> stock <span class="keyword">not</span> <span class="keyword">in</span> to_hold:</span><br><span class="line">            order_target(stock, <span class="number">0</span>) <span class="comment">#清仓</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 要持有但是还没有买的票</span></span><br><span class="line">    to_buy = [stock <span class="keyword">for</span> stock <span class="keyword">in</span> to_hold <span class="keyword">if</span> stock <span class="keyword">not</span> <span class="keyword">in</span> context.portfolio.positions]</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 买入新持有的票</span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(to_buy) &gt;<span class="number">0</span>:</span><br><span class="line">        cash_per_stock = context.portfolio.available_cash / <span class="built_in">len</span>(to_buy) <span class="comment"># 资金平均分配</span></span><br><span class="line">        <span class="keyword">for</span> stock <span class="keyword">in</span> to_buy:</span><br><span class="line">            order_value(stock, cash_per_stock)</span><br></pre></td></tr></table></figure>

<p><img src="https://i.loli.net/2021/05/27/9gIFVX5YxoNjuEr.png" alt="strategy5result.PNG"></p>
<blockquote>
<p>不同因子的数据量级不同，需要做数据归一化处理（缩放到[0,1]之间），再做评分模型。</p>
</blockquote>
<p>$$<br>x^* = \frac{x - min}{max-min}, 或<br>x^* = \frac{x - \mu}{\sigma}<br>$$</p>
<h3 id="2-6-均值回归"><a href="#2-6-均值回归" class="headerlink" title="2.6 均值回归"></a>2.6 均值回归</h3><blockquote>
<p>跌下去的迟早要涨上来。</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 策略：均值回归（单因子选股）</span></span><br><span class="line"><span class="comment"># 标的：沪深300</span></span><br><span class="line"><span class="comment"># 调仓：每月第1个交易日</span></span><br><span class="line"><span class="comment"># 策略：</span></span><br><span class="line"><span class="comment">#   1. 计算池中所有股票的N日均线，与均线的下跌偏离度 (MA - P)/ MA</span></span><br><span class="line"><span class="comment">#   2. 选取下跌偏离度最高的M只股票并调仓</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">initialize</span>(<span class="params">context</span>):</span></span><br><span class="line">    <span class="comment"># 基本设置</span></span><br><span class="line">    set_option(<span class="string">&#x27;use_real_price&#x27;</span>, <span class="literal">True</span>) <span class="comment"># 开启动态复权模式(真实价格)</span></span><br><span class="line">    set_order_cost(OrderCost(close_tax=<span class="number">0.001</span>, open_commission=<span class="number">0.0003</span>, close_commission=<span class="number">0.0003</span>,</span><br><span class="line">                            min_commission=<span class="number">5</span>), <span class="built_in">type</span>=<span class="string">&#x27;stock&#x27;</span>) <span class="comment">#印花税、佣金</span></span><br><span class="line">    set_benchmark(<span class="string">&#x27;000300.XSHG&#x27;</span>) <span class="comment"># 设置比较基准（红线）</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 标的选择</span></span><br><span class="line">    g.security = get_index_stocks(<span class="string">&#x27;000300.XSHG&#x27;</span>) <span class="comment"># 选定股票池为沪深300</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 参数设置</span></span><br><span class="line">    g.ma_days = <span class="number">30</span> <span class="comment"># 均线</span></span><br><span class="line">    g.stock_num = <span class="number">10</span> <span class="comment"># 持仓股票数</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 调仓函数</span></span><br><span class="line">    <span class="comment">#run_daily(period, time=&#x27;every_bar&#x27;) #指定每天跑什么函数（period）</span></span><br><span class="line">    run_monthly(period, <span class="number">1</span>) <span class="comment"># 每月1一个交易日执行period函数</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">period</span>(<span class="params">context</span>):</span></span><br><span class="line">    </span><br><span class="line">    sr = pd.Series(index = g.security)</span><br><span class="line">    <span class="keyword">for</span> stock <span class="keyword">in</span> sr.index:</span><br><span class="line">        <span class="comment"># 计算所有股票当日的下跌偏离度</span></span><br><span class="line">        ma = attribute_history(stock, g.ma_days)[<span class="string">&#x27;close&#x27;</span>].mean() <span class="comment">#当日30日均线</span></span><br><span class="line">        p = get_current_data()[stock].day_open <span class="comment">#股票当日开盘价</span></span><br><span class="line">        ratio = (ma - p) / ma <span class="comment"># 下跌偏离度</span></span><br><span class="line">        sr[stock] = ratio</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 排序并找到偏离度最高的10只票,准备持有</span></span><br><span class="line">    to_hold = sr.nlargest(g.stock_num).index.values <span class="comment">#速度快于sort_values函数</span></span><br><span class="line">    <span class="comment"># sort排序方法，与nlargest方法结果对应不上</span></span><br><span class="line">    <span class="comment">#tohold = sr.sort_values().iloc[:g.stock_num].index.values</span></span><br><span class="line">    <span class="comment">#print(tohold)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 不在持有名单的票：卖掉</span></span><br><span class="line">    <span class="keyword">for</span> stock <span class="keyword">in</span> context.portfolio.positions:</span><br><span class="line">        <span class="keyword">if</span> stock <span class="keyword">not</span> <span class="keyword">in</span> to_hold:</span><br><span class="line">            order_target_value(stock, <span class="number">0</span>) <span class="comment">#清仓</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 要持有但是还没有买的票</span></span><br><span class="line">    to_buy = [stock <span class="keyword">for</span> stock <span class="keyword">in</span> to_hold <span class="keyword">if</span> stock <span class="keyword">not</span> <span class="keyword">in</span> context.portfolio.positions]</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 买入新持有的票</span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(to_buy) &gt;<span class="number">0</span>:</span><br><span class="line">        cash_per_stock = context.portfolio.available_cash / <span class="built_in">len</span>(to_buy) <span class="comment"># 资金平均分配</span></span><br><span class="line">        <span class="keyword">for</span> stock <span class="keyword">in</span> to_buy:</span><br><span class="line">            order_value(stock, cash_per_stock)</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="https://i.loli.net/2021/05/27/JQCfrwL1PVkIi3X.png" alt="strategy6result.PNG"></p>
<h3 id="2-7-布林带策略"><a href="#2-7-布林带策略" class="headerlink" title="2.7 布林带策略"></a>2.7 布林带策略</h3><blockquote>
<p>Bollinger Band（布林带/布林线/保利加通道）：择时（P&gt; up线则清仓，P&lt;down线则买入）</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 策略：布林带策略</span></span><br><span class="line"><span class="comment"># 类型：择时</span></span><br><span class="line"><span class="comment"># 标的：贵州茅台</span></span><br><span class="line"><span class="comment"># 策略：</span></span><br><span class="line"><span class="comment">#   1. P &gt; UP线 且 持仓：清仓</span></span><br><span class="line"><span class="comment">#   2. P &gt; down线 且 未持仓：买入</span></span><br><span class="line"><span class="comment"># 参数：</span></span><br><span class="line"><span class="comment">#   g.N = 20 ：20日均线</span></span><br><span class="line"><span class="comment">#   g.k = 2 ：布林带宽度</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">initialize</span>(<span class="params">context</span>):</span></span><br><span class="line">    <span class="comment"># 基本设置</span></span><br><span class="line">    set_benchmark(<span class="string">&#x27;000300.XSHG&#x27;</span>) <span class="comment"># 设置比较基准（红线）</span></span><br><span class="line">    set_option(<span class="string">&#x27;use_real_price&#x27;</span>, <span class="literal">True</span>) <span class="comment"># 开启动态复权模式(真实价格)</span></span><br><span class="line">    set_order_cost(OrderCost(close_tax=<span class="number">0.001</span>, open_commission=<span class="number">0.0003</span>, close_commission=<span class="number">0.0003</span>,</span><br><span class="line">                            min_commission=<span class="number">5</span>), <span class="built_in">type</span>=<span class="string">&#x27;stock&#x27;</span>) <span class="comment">#</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 调仓函数</span></span><br><span class="line">    run_daily(period, time=<span class="string">&#x27;every_bar&#x27;</span>) <span class="comment">#指定每天跑什么函数（period）</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 标的选择</span></span><br><span class="line">    g.security = <span class="string">&#x27;600519.XSHG&#x27;</span> <span class="comment"># 选定交易股票为茅台</span></span><br><span class="line">    g.M = <span class="number">20</span> <span class="comment"># 20日均线</span></span><br><span class="line">    g.k = <span class="number">2</span> <span class="comment"># 布林带宽度</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">period</span>(<span class="params">context</span>):</span></span><br><span class="line">    sr = attribute_history(g.security, g.M)[<span class="string">&#x27;close&#x27;</span>] <span class="comment"># 前M日收盘价</span></span><br><span class="line">    ma = sr.mean() <span class="comment">#M日均线</span></span><br><span class="line">    up = ma + g.k * sr.std()</span><br><span class="line">    down = ma - g.k * sr.std()</span><br><span class="line">    p = get_current_data()[g.security].day_open <span class="comment">#当前价</span></span><br><span class="line">    cash = context.portfolio.available_cash <span class="comment">#持有现金</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> p &lt; down <span class="keyword">and</span> g.security <span class="keyword">not</span> <span class="keyword">in</span> context.portfolio.positions:</span><br><span class="line">        order_value(g.security, cash)</span><br><span class="line">    <span class="keyword">elif</span> p &gt; up <span class="keyword">and</span> g.security <span class="keyword">in</span> context.portfolio.positions:</span><br><span class="line">        order_target(g.security, <span class="number">0</span>)</span><br></pre></td></tr></table></figure>

<p><img src="https://i.loli.net/2021/05/27/vclIrE7DU2hBoN9.png" alt="strategy7result.PNG"></p>
<h3 id="2-8-PEG策略"><a href="#2-8-PEG策略" class="headerlink" title="2.8 PEG策略"></a>2.8 PEG策略</h3><blockquote>
<p>股票定价合理的公司，市盈率= 收益增长率。（彼得.林奇）</p>
</blockquote>
<p>$$<br>PEG = \frac{PE}{G \times 100}，PE = \frac{P}{EPS}，G = \frac{EPS(i)-EPS(i-1)}{EPS(i-1)}，P为股价，EPS是每股收益<br>$$</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 策略：PEG </span></span><br><span class="line"><span class="comment"># 类型：选股</span></span><br><span class="line"><span class="comment"># 标的：沪深300池</span></span><br><span class="line"><span class="comment"># 策略：</span></span><br><span class="line"><span class="comment">#   1.选择PEG最小的N只股票调仓</span></span><br><span class="line"><span class="comment">#   2.过滤掉PE或收益增长率为负的票</span></span><br><span class="line"><span class="comment"># 调仓：每月第1个交易日</span></span><br><span class="line"><span class="comment"># 参数：N</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> jqdata <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">initialize</span>(<span class="params">context</span>):</span></span><br><span class="line">    <span class="comment"># 基本设置</span></span><br><span class="line">    set_option(<span class="string">&#x27;use_real_price&#x27;</span>, <span class="literal">True</span>) <span class="comment"># 开启动态复权模式(真实价格)</span></span><br><span class="line">    set_order_cost(OrderCost(close_tax=<span class="number">0.001</span>, open_commission=<span class="number">0.0003</span>, close_commission=<span class="number">0.0003</span>,</span><br><span class="line">                            min_commission=<span class="number">5</span>), <span class="built_in">type</span>=<span class="string">&#x27;stock&#x27;</span>) <span class="comment">#印花税、佣金</span></span><br><span class="line">    set_benchmark(<span class="string">&#x27;000300.XSHG&#x27;</span>) <span class="comment"># 设置比较基准（红线）</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 标的选择</span></span><br><span class="line">    g.security = get_index_stocks(<span class="string">&#x27;000300.XSHG&#x27;</span>) <span class="comment"># 选定股票池为沪深300</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 参数设置</span></span><br><span class="line">    g.N = <span class="number">20</span> <span class="comment"># 持仓股票数</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 财务数据所在列表定位（PE，收益增长率）</span></span><br><span class="line">    g.q = query(valuation.code, valuation.pe_ratio, indicator.inc_net_profit_year_on_year).<span class="built_in">filter</span>(valuation.code.in_(g.security))</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 调仓函数</span></span><br><span class="line">    <span class="comment">#run_daily(period, time=&#x27;every_bar&#x27;) #指定每天跑什么函数（period）</span></span><br><span class="line">    run_monthly(period, <span class="number">1</span>) <span class="comment"># 每月1一个交易日执行period函数</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">period</span>(<span class="params">context</span>):</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 指标计算</span></span><br><span class="line">    df = get_fundamentals(g.q) <span class="comment"># 财务数据获取（PE，收益增长率）</span></span><br><span class="line">    df = df[(df[<span class="string">&#x27;pe_ratio&#x27;</span>]&gt;<span class="number">0</span>) &amp; (df[<span class="string">&#x27;inc_net_profit_year_on_year&#x27;</span>]&gt;<span class="number">0</span>)] <span class="comment">#过滤异常数据</span></span><br><span class="line">    df[<span class="string">&#x27;peg&#x27;</span>] = df[<span class="string">&#x27;pe_ratio&#x27;</span>] / df[<span class="string">&#x27;inc_net_profit_year_on_year&#x27;</span>] /<span class="number">100</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 排序并找到PEG最小的N只票,准备持有</span></span><br><span class="line">    df = df.sort_values(<span class="string">&#x27;peg&#x27;</span>)</span><br><span class="line">    to_hold = df.iloc[:g.N][<span class="string">&#x27;code&#x27;</span>].values </span><br><span class="line">    <span class="comment">#to_hold = df[&#x27;code&#x27;][:g.N].values # 两种写法皆可</span></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line">    <span class="comment"># 不在持有名单的票：卖掉</span></span><br><span class="line">    <span class="keyword">for</span> stock <span class="keyword">in</span> context.portfolio.positions:</span><br><span class="line">        <span class="keyword">if</span> stock <span class="keyword">not</span> <span class="keyword">in</span> to_hold:</span><br><span class="line">            order_target_value(stock, <span class="number">0</span>) <span class="comment">#清仓</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 要持有但是还没有买的票</span></span><br><span class="line">    to_buy = [stock <span class="keyword">for</span> stock <span class="keyword">in</span> to_hold <span class="keyword">if</span> stock <span class="keyword">not</span> <span class="keyword">in</span> context.portfolio.positions]</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 买入新持有的票</span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(to_buy) &gt;<span class="number">0</span>:</span><br><span class="line">        cash_per_stock = context.portfolio.available_cash / <span class="built_in">len</span>(to_buy) <span class="comment"># 资金平均分配</span></span><br><span class="line">        <span class="keyword">for</span> stock <span class="keyword">in</span> to_buy:</span><br><span class="line">            order_value(stock, cash_per_stock)</span><br></pre></td></tr></table></figure>

<p><img src="https://i.loli.net/2021/05/27/kL7gmI2RauENFWU.png" alt="strategy8result.PNG"></p>
<h3 id="2-9-动量反转策略"><a href="#2-9-动量反转策略" class="headerlink" title="2.9 动量反转策略"></a>2.9 动量反转策略</h3><blockquote>
<p>涨得猛的还会继续涨（动量策略）；涨得少的会补涨（反转策略）</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 策略： 动量反转策略</span></span><br><span class="line"><span class="comment"># 类型：选股</span></span><br><span class="line"><span class="comment"># 标的：沪深300池</span></span><br><span class="line"><span class="comment"># 策略：</span></span><br><span class="line"><span class="comment">#   选择收益率最大的N只票调仓（动量策略）</span></span><br><span class="line"><span class="comment">#   选择收益率最小的N只票调仓（反转策略）</span></span><br><span class="line"><span class="comment"># 调仓：每月第1个交易日</span></span><br><span class="line"><span class="comment"># 参数：N</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> jqdata <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">initialize</span>(<span class="params">context</span>):</span></span><br><span class="line">    <span class="comment"># 基本设置</span></span><br><span class="line">    set_option(<span class="string">&#x27;use_real_price&#x27;</span>, <span class="literal">True</span>) <span class="comment"># 开启动态复权模式(真实价格)</span></span><br><span class="line">    set_order_cost(OrderCost(close_tax=<span class="number">0.001</span>, open_commission=<span class="number">0.0003</span>, close_commission=<span class="number">0.0003</span>,</span><br><span class="line">                            min_commission=<span class="number">5</span>), <span class="built_in">type</span>=<span class="string">&#x27;stock&#x27;</span>) <span class="comment">#印花税、佣金</span></span><br><span class="line">    set_benchmark(<span class="string">&#x27;000300.XSHG&#x27;</span>) <span class="comment"># 设置比较基准（红线）</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 标的选择</span></span><br><span class="line">    g.security = get_index_stocks(<span class="string">&#x27;000300.XSHG&#x27;</span>) <span class="comment"># 选定股票池为沪深300</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 参数设置</span></span><br><span class="line">    g.N = <span class="number">10</span> <span class="comment"># 持仓股票数</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 调仓函数</span></span><br><span class="line">    <span class="comment">#run_daily(period, time=&#x27;every_bar&#x27;) #指定每天跑什么函数（period）</span></span><br><span class="line">    run_monthly(period, <span class="number">1</span>) <span class="comment"># 每月1一个交易日执行period函数</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">period</span>(<span class="params">context</span>):</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 获取股票池中30天的收盘价</span></span><br><span class="line">    df_close = history(<span class="number">30</span>, field=<span class="string">&#x27;close&#x27;</span>, security_list = <span class="built_in">list</span>(g.security)).T <span class="comment">#转置</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 收益率计算</span></span><br><span class="line">    df_close[<span class="string">&#x27;ret&#x27;</span>] = (df_close.iloc[:,-<span class="number">1</span>] - df_close.iloc[:,<span class="number">0</span>]) / df_close.iloc[:,<span class="number">0</span>]</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 排序（降序）</span></span><br><span class="line">    sorted_stocks = df_close.sort_values(<span class="string">&#x27;ret&#x27;</span>, ascending = <span class="literal">False</span>).index.values </span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 准备持有的票</span></span><br><span class="line">    <span class="comment">#to_hold = sorted_stocks[:g.N] # 动量策略（找最大的N只票持有）</span></span><br><span class="line">    to_hold = sorted_stocks[-g.N:] <span class="comment"># 反转策略（找最小的N只票持有）</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 不在持有名单的票：卖掉</span></span><br><span class="line">    <span class="keyword">for</span> stock <span class="keyword">in</span> context.portfolio.positions:</span><br><span class="line">        <span class="keyword">if</span> stock <span class="keyword">not</span> <span class="keyword">in</span> to_hold:</span><br><span class="line">            order_target_value(stock, <span class="number">0</span>) <span class="comment">#清仓</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 要持有但是还没有买的票</span></span><br><span class="line">    to_buy = [stock <span class="keyword">for</span> stock <span class="keyword">in</span> to_hold <span class="keyword">if</span> stock <span class="keyword">not</span> <span class="keyword">in</span> context.portfolio.positions]</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 买入新持有的票</span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(to_buy) &gt;<span class="number">0</span>:</span><br><span class="line">        cash_per_stock = context.portfolio.available_cash / <span class="built_in">len</span>(to_buy) <span class="comment"># 资金平均分配</span></span><br><span class="line">        <span class="keyword">for</span> stock <span class="keyword">in</span> to_buy:</span><br><span class="line">            order_value(stock, cash_per_stock)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>动量策略：</p>
<p><img src="https://i.loli.net/2021/05/27/rmboSFdiwpX6ATc.png" alt="strategy9result.PNG"></p>
<p>反转策略：</p>
<p><img src="https://i.loli.net/2021/05/27/ELdMQsXJ5OVnl9i.png" alt="strategy10result.PNG"></p>
<h3 id="2-10-羊驼交易法"><a href="#2-10-羊驼交易法" class="headerlink" title="2.10 羊驼交易法"></a>2.10 羊驼交易法</h3><blockquote>
<p>随机选股，周期调仓。</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 策略： 羊驼交易法</span></span><br><span class="line"><span class="comment"># 类型：选股</span></span><br><span class="line"><span class="comment"># 标的：沪深300池</span></span><br><span class="line"><span class="comment"># 策略：</span></span><br><span class="line"><span class="comment">#   1. 随机选取N只股票（改进：买入历史收益率最低的N只票）</span></span><br><span class="line"><span class="comment">#   2. 调仓时卖掉M只收益率最差的票，再随机买入M只票（改进：买入池中收益率最低的N只票）</span></span><br><span class="line"><span class="comment"># 调仓：每月第1个交易日</span></span><br><span class="line"><span class="comment"># 参数：N</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> jqdata <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">initialize</span>(<span class="params">context</span>):</span></span><br><span class="line">    <span class="comment"># 基本设置</span></span><br><span class="line">    set_option(<span class="string">&#x27;use_real_price&#x27;</span>, <span class="literal">True</span>) <span class="comment"># 开启动态复权模式(真实价格)</span></span><br><span class="line">    set_order_cost(OrderCost(close_tax=<span class="number">0.001</span>, open_commission=<span class="number">0.0003</span>, close_commission=<span class="number">0.0003</span>,</span><br><span class="line">                            min_commission=<span class="number">5</span>), <span class="built_in">type</span>=<span class="string">&#x27;stock&#x27;</span>) <span class="comment">#印花税、佣金</span></span><br><span class="line">    set_benchmark(<span class="string">&#x27;000300.XSHG&#x27;</span>) <span class="comment"># 设置比较基准（红线）</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 标的选择</span></span><br><span class="line">    g.security = get_index_stocks(<span class="string">&#x27;000300.XSHG&#x27;</span>) <span class="comment"># 选定股票池为沪深300</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 参数设置</span></span><br><span class="line">    g.period = <span class="number">30</span> <span class="comment">#收益率计算周期</span></span><br><span class="line">    g.N = <span class="number">10</span> <span class="comment">#持仓股票数</span></span><br><span class="line">    g.change = <span class="number">1</span> <span class="comment">#调仓股票数</span></span><br><span class="line">    g.init = <span class="literal">True</span> <span class="comment">#标志位</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 调仓函数</span></span><br><span class="line">    <span class="comment">#run_daily(period, time=&#x27;every_bar&#x27;) #指定每天跑什么函数（period）</span></span><br><span class="line">    run_monthly(period, <span class="number">1</span>) <span class="comment"># 每月1一个交易日执行period函数</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#按收益率排序函数（降序）</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_sorted_stocks</span>(<span class="params">context, stocks</span>):</span></span><br><span class="line">    df = history(g.period, field=<span class="string">&#x27;close&#x27;</span>, security_list = <span class="built_in">list</span>(stocks)).T</span><br><span class="line">    df[<span class="string">&#x27;ret&#x27;</span>] = (df.iloc[:,-<span class="number">1</span>] - df.iloc[:,<span class="number">0</span>]) / df.iloc[:,<span class="number">0</span>]</span><br><span class="line">    df = df.sort_values(<span class="string">&#x27;ret&#x27;</span>, ascending = <span class="literal">False</span>)</span><br><span class="line">    <span class="keyword">return</span> df.index.values</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">period</span>(<span class="params">context</span>):</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> g.init: <span class="comment">#初始买入</span></span><br><span class="line">        stocks = get_sorted_stocks(context, g.security)[:g.N]</span><br><span class="line">        cash = context.portfolio.available_cash * <span class="number">0.9</span> / <span class="built_in">len</span>(stocks)</span><br><span class="line">        <span class="keyword">for</span> stock <span class="keyword">in</span> stocks:</span><br><span class="line">            order_value(stock, cash)</span><br><span class="line">        g.init = <span class="literal">False</span></span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">#现有持仓降序排序</span></span><br><span class="line">    stocks =  get_sorted_stocks(context, context.portfolio.positions.keys())</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 把表现最差的M只票卖掉</span></span><br><span class="line">    <span class="keyword">for</span> stock <span class="keyword">in</span> stocks[-g.change:]:</span><br><span class="line">        order_target(stock, <span class="number">0</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 买入池中收益率最低的M只票</span></span><br><span class="line">    stocks = get_sorted_stocks(context, g.security)</span><br><span class="line">    <span class="keyword">for</span> stock <span class="keyword">in</span> stocks:</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(context.portfolio.positions) &gt;= g.N: <span class="comment">#现有持仓超过N只便不再买入</span></span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">if</span> stock <span class="keyword">not</span> <span class="keyword">in</span> context.portfolio.positions: <span class="comment">#新增持仓</span></span><br><span class="line">            order_value(stock, context.portfolio.available_cash * <span class="number">0.9</span>)</span><br><span class="line">    </span><br><span class="line">    </span><br></pre></td></tr></table></figure>

<p><img src="https://i.loli.net/2021/05/27/djtuRmDflicS2EH.png" alt="strategy11result.PNG"></p>
<blockquote>
<p>还有海龟交易法，鳄鱼交易法等。</p>
</blockquote>
<hr>
<h2 id="0x04-回测框架"><a href="#0x04-回测框架" class="headerlink" title="0x04 回测框架"></a>0x04 回测框架</h2><p>本地回测框架需要满足下列基本功能：</p>
<ol>
<li>保存上下文信息（用户数据，回测时间段，持仓信息等）</li>
<li>获取历史数据</li>
<li>下单函数（买什么，买多少，什么时间价格买）</li>
<li>用户接口（输入参数，实现策略等）</li>
</ol>
<h3 id="4-0-准备工作"><a href="#4-0-准备工作" class="headerlink" title="4.0 准备工作"></a>4.0 准备工作</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># coding=utf-8</span></span><br><span class="line"><span class="comment"># !/usr/bin/python</span></span><br><span class="line"><span class="comment"># python : 3.8.8</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#库</span></span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line"><span class="keyword">import</span> tushare</span><br><span class="line"><span class="keyword">import</span> datetime</span><br><span class="line"><span class="keyword">import</span> dateutil</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"></span><br><span class="line"><span class="comment">#参数设置 </span></span><br><span class="line"><span class="comment">#    对标聚宽右上角参数设置栏</span></span><br><span class="line">CASH = <span class="number">100000000</span> <span class="comment">#可用资金</span></span><br><span class="line">START_DATE = <span class="string">&#x27;2016-01-07&#x27;</span> <span class="comment">#回测开始时间</span></span><br><span class="line">END_DATE = <span class="string">&#x27;2016-01-31&#x27;</span> <span class="comment">#回测结束时间</span></span><br></pre></td></tr></table></figure>

<h3 id="4-1-保存上下文信息"><a href="#4-1-保存上下文信息" class="headerlink" title="4.1 保存上下文信息"></a>4.1 保存上下文信息</h3><h4 id="4-1-1-获取全部交易日期"><a href="#4-1-1-获取全部交易日期" class="headerlink" title="4.1.1 获取全部交易日期"></a>4.1.1 获取全部交易日期</h4><blockquote>
<p>本地读取之前生成的交易日文件，生成方式<a target="_blank" rel="noopener" href="https://meilongzhendongzi.github.io/2021/05/28/tushare-trade-cal-%E5%A4%B1%E6%95%88%E7%9A%84%E8%A7%A3%E5%86%B3%E6%96%B9%E6%B3%95/">戳这里</a>。</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#获取1990-12-19至今全部日期并存为csv, &quot;calendarDate&quot;列为日期，对应&quot;isOpen&quot;01列，&quot;1&quot;表示为交易日</span></span><br><span class="line"><span class="comment">#替代tushare.trade_cal()= pd.read_csv(&#x27;http://file.tushare.org/tsdata/calAll.csv&#x27;)</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">trade_cal_new</span>():</span></span><br><span class="line">    today = datetime.date.today() <span class="comment">#今天</span></span><br><span class="line">    all_days = pd.date_range(<span class="string">&#x27;1990-12-19&#x27;</span>, today) <span class="comment">#全部日期，type(all_days) = DatetimeIndex, type(all_days[i]) = Timestamp</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">#交易日</span></span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;work_day.txt&#x27;</span>,<span class="string">&#x27;r&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        work_days_list = f.readlines() <span class="comment"># &#x27;1990-12-19\n&#x27;</span></span><br><span class="line">        <span class="comment">#work_days = pd.to_datetime(work_days_list) #type(work_days) = DatetimeIndex, type(work_days[i]) = Timestamp</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">#判断工作日数据是否要更新</span></span><br><span class="line">        last_days_year = work_days_list[-<span class="number">1</span>].split(<span class="string">&#x27;-&#x27;</span>)[<span class="number">0</span>]</span><br><span class="line">        <span class="keyword">if</span> today.year &gt; <span class="built_in">int</span>(last_days_year):</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&#x27;工作日数据需要更新&#x27;</span>)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        </span><br><span class="line">    <span class="comment">#添加01列</span></span><br><span class="line">    trade_cal = pd.DataFrame(np.zeros(<span class="built_in">len</span>(all_days), <span class="built_in">int</span>), index = all_days, columns = [<span class="string">&#x27;isOpen&#x27;</span>])</span><br><span class="line">    <span class="keyword">for</span> day <span class="keyword">in</span> all_days:   </span><br><span class="line">        <span class="keyword">if</span> day.strftime(<span class="string">&quot;%Y-%m-%d&quot;</span>)+<span class="string">&#x27;\n&#x27;</span> <span class="keyword">in</span> work_days_list:</span><br><span class="line">            trade_cal.loc[day] = <span class="number">1</span></span><br><span class="line">            </span><br><span class="line">    <span class="comment">#添加calendarDate列</span></span><br><span class="line">    trade_cal[<span class="string">&#x27;calendarDate&#x27;</span>] = all_days</span><br><span class="line">    </span><br><span class="line">    <span class="comment">#保存为csv</span></span><br><span class="line">    trade_cal.to_csv(<span class="string">&quot;trade_cal_%s.csv&quot;</span> % (today.strftime(<span class="string">&quot;%Y-%m-%d&quot;</span>)))</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> trade_cal</span><br><span class="line"></span><br><span class="line">trade_cal = trade_cal_new() <span class="comment">#全部交易日期</span></span><br><span class="line"><span class="comment">#print(trade_cal)</span></span><br></pre></td></tr></table></figure>

<h4 id="4-1-2-保存上下文信息的类"><a href="#4-1-2-保存上下文信息的类" class="headerlink" title="4.1.2 保存上下文信息的类"></a>4.1.2 保存上下文信息的类</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#保存上下文信息的类</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Context</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, cash, start_date, end_date</span>):</span></span><br><span class="line">        self.cash = cash <span class="comment">#可用资金</span></span><br><span class="line">        self.start_date = start_date <span class="comment">#回测开始时间 </span></span><br><span class="line">        self.end_date = end_date <span class="comment">#回测结束时间</span></span><br><span class="line">        self.positions = &#123;&#125; <span class="comment">#持仓信息</span></span><br><span class="line">        self.benchmark = <span class="literal">None</span> <span class="comment">#比较基准</span></span><br><span class="line">        self.date_range = trade_cal[(trade_cal[<span class="string">&quot;isOpen&quot;</span>]==<span class="number">1</span>) &amp; \</span><br><span class="line">                                    (trade_cal[<span class="string">&#x27;calendarDate&#x27;</span>]&gt;=start_date) &amp; \</span><br><span class="line">                                    (trade_cal[<span class="string">&#x27;calendarDate&#x27;</span>]&lt;=end_date) ].index <span class="comment">#取开始和结束时间中间所有的交易日期</span></span><br><span class="line">        <span class="comment">#self.date = datetime.datetime.strptime(&quot;&quot;, start_date) #模拟当天日期（格式化）</span></span><br><span class="line">        <span class="comment">#self.date = dateutil.parser.parse(start_date) #模拟当天的日期（格式化）</span></span><br><span class="line">        self.date = <span class="literal">None</span> <span class="comment">#模拟当天的日期，后面在run()中赋值</span></span><br><span class="line">        </span><br><span class="line">context = Context(CASH, START_DATE, END_DATE)</span><br><span class="line"><span class="comment">#print(context.date_range)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#保存全局变量的类</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">G</span>:</span></span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">g = G()</span><br></pre></td></tr></table></figure>

<h3 id="4-2-获取历史数据"><a href="#4-2-获取历史数据" class="headerlink" title="4.2 获取历史数据"></a>4.2 获取历史数据</h3><h4 id="4-2-1-获取时间段内的数据"><a href="#4-2-1-获取时间段内的数据" class="headerlink" title="4.2.1 获取时间段内的数据"></a>4.2.1 获取时间段内的数据</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#获取时间段内的股票数据</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">attribute_daterange_history</span>(<span class="params">security, start_date, end_date, fields=(<span class="params"><span class="string">&#x27;open&#x27;</span>, <span class="string">&#x27;close&#x27;</span>,<span class="string">&#x27;high&#x27;</span>,<span class="string">&#x27;low&#x27;</span>, <span class="string">&#x27;volume&#x27;</span></span>)</span>):</span></span><br><span class="line">    <span class="keyword">try</span>: <span class="comment">#</span></span><br><span class="line">        f = <span class="built_in">open</span>(security+<span class="string">&#x27;.csv&#x27;</span>, <span class="string">&#x27;r&#x27;</span>)</span><br><span class="line">        df = pd.read_csv(security+<span class="string">&#x27;.csv&#x27;</span>, index_col=<span class="string">&#x27;date&#x27;</span>, parse_dates=[<span class="string">&#x27;date&#x27;</span>]).loc[start_date:end_date, :]</span><br><span class="line">    <span class="keyword">except</span> FileNotFoundError:</span><br><span class="line">        df = tushare.get_k_data(security, start_date, end_date)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> df[<span class="built_in">list</span>(fields)]</span><br><span class="line"></span><br><span class="line"><span class="comment">#print(attribute_daterange_history(&#x27;600519&#x27;, &#x27;2015-03-01&#x27;,&#x27;2016-02-10&#x27;))</span></span><br></pre></td></tr></table></figure>

<h4 id="4-2-2-获取前N天的股票数据"><a href="#4-2-2-获取前N天的股票数据" class="headerlink" title="4.2.2 获取前N天的股票数据"></a>4.2.2 获取前N天的股票数据</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#从模拟日期的前一天起算，往前数count天的security股票数据</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">attribute_history</span>(<span class="params">security, count, fields=(<span class="params"><span class="string">&#x27;open&#x27;</span>, <span class="string">&#x27;close&#x27;</span>,<span class="string">&#x27;high&#x27;</span>,<span class="string">&#x27;low&#x27;</span>, <span class="string">&#x27;volume&#x27;</span></span>)</span>):</span></span><br><span class="line">    <span class="comment">#模拟日期的前一天</span></span><br><span class="line">    end_date = (context.date - datetime.timedelta(days=<span class="number">1</span>)).strftime(<span class="string">&#x27;%Y-%m-%d&#x27;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment">#从模拟当天前一天起算，往前数count天</span></span><br><span class="line">    start_date = trade_cal[(trade_cal[<span class="string">&#x27;isOpen&#x27;</span>]==<span class="number">1</span>) &amp; \</span><br><span class="line">                            (trade_cal[<span class="string">&#x27;calendarDate&#x27;</span>]&lt;= end_date)][-count:].iloc[<span class="number">0</span>,:][<span class="string">&#x27;calendarDate&#x27;</span>] </span><br><span class="line">    <span class="comment">#print(end_date, start_date)</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> attribute_daterange_history(security, start_date, end_date, fields)</span><br><span class="line"></span><br><span class="line"><span class="comment">#attribute_history(&#x27;600519&#x27;,10)</span></span><br></pre></td></tr></table></figure>

<h3 id="4-3-下单函数"><a href="#4-3-下单函数" class="headerlink" title="4.3 下单函数"></a>4.3 下单函数</h3><h4 id="4-3-1-获取模拟日期的股价"><a href="#4-3-1-获取模拟日期的股价" class="headerlink" title="4.3.1 获取模拟日期的股价"></a>4.3.1 获取模拟日期的股价</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#获取今日股价</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_today_data</span>(<span class="params">security</span>):</span></span><br><span class="line">    today = context.date.strftime(<span class="string">&#x27;%Y-%m-%d&#x27;</span>)</span><br><span class="line">    <span class="keyword">try</span>: <span class="comment">#如果本地存在数据</span></span><br><span class="line">        f = <span class="built_in">open</span>(security+<span class="string">&#x27;.csv&#x27;</span>,<span class="string">&#x27;r&#x27;</span>)</span><br><span class="line">        data = pd.read_csv(security+<span class="string">&#x27;.csv&#x27;</span>, index_col=<span class="string">&#x27;date&#x27;</span>, parse_dates=[<span class="string">&#x27;date&#x27;</span>]).loc[today,:]</span><br><span class="line">    <span class="keyword">except</span> FileNotFoundError:</span><br><span class="line">        data = tushare.get_k_data(security, today, today).iloc[<span class="number">0</span>,:]</span><br><span class="line">    <span class="keyword">except</span> KeyError: <span class="comment">#股票停牌或今天非交易日</span></span><br><span class="line">        data = pd.Series() <span class="comment">#传入空数据</span></span><br><span class="line">    <span class="keyword">return</span> data</span><br><span class="line"></span><br><span class="line"><span class="comment">#print(&#x27;600519&#x27;) #默认今天为START_DATE</span></span><br></pre></td></tr></table></figure>

<h4 id="4-3-2-基础下单函数"><a href="#4-3-2-基础下单函数" class="headerlink" title="4.3.2 基础下单函数"></a>4.3.2 基础下单函数</h4><blockquote>
<p>此处尚未实现扣除交易费用和T+1两项功能（context.positions设置两个值，当日买入后锁仓即可）。</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#下单多少股</span></span><br><span class="line"><span class="comment">#amount&gt;0: 买； amount&lt;0: 卖</span></span><br><span class="line"><span class="comment">#这里用开盘价下单，但一般是在此基础上加滑点</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">_order</span>(<span class="params">today_data, security, amount</span>):</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">#停牌</span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(today_data) == <span class="number">0</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;今日停牌&#x27;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="comment">#退出</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        p = today_data[<span class="string">&#x27;open&#x27;</span>]</span><br><span class="line">    </span><br><span class="line">    <span class="comment">#可用的钱不够</span></span><br><span class="line">    <span class="keyword">if</span> context.cash - amount * p &lt; <span class="number">0</span>: </span><br><span class="line">        amount = <span class="built_in">int</span>(context.cash / p) <span class="comment">#此时最多能买多少股</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;现金不足,已调整为买入%d股&quot;</span> % (amount))</span><br><span class="line">    </span><br><span class="line">    <span class="comment">#买卖股数不是100的倍数</span></span><br><span class="line">    <span class="keyword">if</span> amount % <span class="number">100</span> != <span class="number">0</span> :</span><br><span class="line">        <span class="keyword">if</span> amount != -context.positions.get(security, <span class="number">0</span>) : <span class="comment">#只要不是清仓，都需要调整为100的倍数</span></span><br><span class="line">            amount = <span class="built_in">int</span>(amount / <span class="number">100</span>) * <span class="number">100</span></span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;不是100的倍数，已调整为下单%d股&quot;</span> % amount)</span><br><span class="line"></span><br><span class="line">    <span class="comment">#想卖的股票比持仓的多</span></span><br><span class="line">    <span class="keyword">if</span> context.positions.get(security, <span class="number">0</span>) &lt; -amount: </span><br><span class="line">        amount = -context.positions.get(security, <span class="number">0</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;卖出股票不能超过持仓数，已调整卖出为%d股&quot;</span> % (amount))</span><br><span class="line">    </span><br><span class="line">    <span class="comment">#To Do: T+1</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">#To Do: 交易费用 </span></span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="comment">#更新持仓</span></span><br><span class="line">    context.positions[security] = context.positions.get(security, <span class="number">0</span>) + amount</span><br><span class="line">    <span class="keyword">if</span> context.positions[security] == <span class="number">0</span>: <span class="comment">#清仓后需删除字典（否则逻辑出错）</span></span><br><span class="line">        <span class="keyword">del</span> context.positions[security]</span><br><span class="line">    </span><br><span class="line">    <span class="comment">#更新现金</span></span><br><span class="line">    context.cash -= amount * p</span><br><span class="line"></span><br><span class="line"><span class="comment">#_order(get_today_data(&#x27;600519&#x27;), &#x27;600519&#x27;, 100) #买100手茅台</span></span><br><span class="line"><span class="comment">#print(context.positions) #查看持仓</span></span><br><span class="line"><span class="comment">#print(context.cash) #查看现金</span></span><br></pre></td></tr></table></figure>

<h4 id="4-3-3-四个下单函数"><a href="#4-3-3-四个下单函数" class="headerlink" title="4.3.3 四个下单函数"></a>4.3.3 四个下单函数</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#下单函数1:下单amount股</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">order</span>(<span class="params">security, amount</span>):</span></span><br><span class="line">    today_data = get_today_data(security)</span><br><span class="line">    _order(today_data, security, amount)</span><br><span class="line"></span><br><span class="line"><span class="comment">#下单函数2:使仓位更新到amount股</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">order_target</span>(<span class="params">security, amount</span>):</span></span><br><span class="line">    <span class="keyword">if</span> amount &lt; <span class="number">0</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;数量不能为负，已调整成0&quot;</span>)</span><br><span class="line">        amount = <span class="number">0</span></span><br><span class="line">    </span><br><span class="line">    hold_amount = context.positions.get(security,<span class="number">0</span>) <span class="comment">#目前仓位多少 #ToDo: T+1 （context.positions写两个值， closeable, total）</span></span><br><span class="line">    delta_amount = amount - hold_amount <span class="comment">#为了达到目的需要下单多少股</span></span><br><span class="line">    order(security, delta_amount)</span><br><span class="line">    <span class="comment">#后面两行等价于order()</span></span><br><span class="line">    <span class="comment">#today_data = get_today_data(security)</span></span><br><span class="line">    <span class="comment">#_order(today_data, security, delta_amount)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#下单函数3：按价值下单</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">order_value</span>(<span class="params">security, value</span>):</span></span><br><span class="line">    today_data = get_today_data(security)</span><br><span class="line">    amount = <span class="built_in">int</span>(value / today_data[<span class="string">&#x27;open&#x27;</span>])</span><br><span class="line">    _order(today_data, security, amount)</span><br><span class="line">    </span><br><span class="line"><span class="comment">#下单函数4：使仓位更新到value价值</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">order_target_value</span>(<span class="params">security,value</span>):</span></span><br><span class="line">    <span class="keyword">if</span> value &lt; <span class="number">0</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;价值不能为负，已调整为0&quot;</span>)</span><br><span class="line">        value = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    hold_value = context.positions.get(security, <span class="number">0</span>) * today_data[<span class="string">&#x27;open&#x27;</span>]</span><br><span class="line">    delta_value = value - hold_value</span><br><span class="line">    order_value(security, delta_value)</span><br><span class="line"></span><br><span class="line"><span class="comment">#order(&#x27;600519&#x27;,100)</span></span><br><span class="line"><span class="comment">#order_value(&#x27;600519&#x27;,30000)</span></span><br><span class="line"><span class="comment">#print(context.positions)</span></span><br></pre></td></tr></table></figure>

<h3 id="4-4-回测函数"><a href="#4-4-回测函数" class="headerlink" title="4.4 回测函数"></a>4.4 回测函数</h3><h4 id="4-4-1-用户接口"><a href="#4-4-1-用户接口" class="headerlink" title="4.4.1 用户接口"></a>4.4.1 用户接口</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#基准比较函数</span></span><br><span class="line"><span class="comment">#   此处只支持一只股票作为基准</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">set_benchmark</span>(<span class="params">security</span>):</span></span><br><span class="line">    context.benchmark = security</span><br><span class="line"></span><br><span class="line"><span class="comment">#初始化（输入全局参数）</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">initialize</span>(<span class="params">context</span>):</span></span><br><span class="line">    g.p1 = <span class="number">5</span></span><br><span class="line">    g.p2 = <span class="number">60</span></span><br><span class="line">    g.security = <span class="string">&#x27;600519&#x27;</span></span><br><span class="line">    set_benchmark(g.security)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#策略函数</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">handle_data</span>(<span class="params">context</span>):</span></span><br><span class="line">    <span class="comment">#策略1</span></span><br><span class="line">    <span class="comment">#order(SECURITY,100)</span></span><br><span class="line">		</span><br><span class="line">    <span class="comment">#策略2</span></span><br><span class="line">    hist = attribute_history(g.security, g.p2) <span class="comment">#获取历史数据</span></span><br><span class="line">    ma5 = hist[<span class="string">&#x27;close&#x27;</span>][-g.p1:].mean() <span class="comment">#5日均线</span></span><br><span class="line">    ma60 = hist[<span class="string">&#x27;close&#x27;</span>].mean() <span class="comment">#60日均线</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> ma5 &gt; ma60 <span class="keyword">and</span> g.security <span class="keyword">not</span> <span class="keyword">in</span> context.positions: <span class="comment">#金叉</span></span><br><span class="line">        order_value(g.security, context.cash)</span><br><span class="line">    <span class="keyword">elif</span> ma5 &lt; ma60 <span class="keyword">and</span> g.security <span class="keyword">in</span> context.positions: <span class="comment">#死叉</span></span><br><span class="line">        order_target(g.security, <span class="number">0</span>)</span><br></pre></td></tr></table></figure>

<h4 id="4-4-2-收益函数"><a href="#4-4-2-收益函数" class="headerlink" title="4.4.2 收益函数"></a>4.4.2 收益函数</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">run</span>():</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">#创建数据对象，准备记录每个交易日的收益率</span></span><br><span class="line">    plt_df = pd.DataFrame(index=pd.to_datetime(context.date_range), columns=[<span class="string">&#x27;value&#x27;</span>])</span><br><span class="line">    init_value = context.cash</span><br><span class="line">    initialize(context)</span><br><span class="line">    last_price = &#123;&#125; <span class="comment">#记录最近一个交易日的价格</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">#计算每个交易日的总价值</span></span><br><span class="line">    <span class="keyword">for</span> dt <span class="keyword">in</span> context.date_range:</span><br><span class="line">        dt = dt.strftime(<span class="string">&quot;%Y-%m-%d&quot;</span>) <span class="comment">#timestamp -&gt; str</span></span><br><span class="line">        context.date = dateutil.parser.parse(dt) <span class="comment">#模拟当天日期，赋值</span></span><br><span class="line">        handle_data(context) <span class="comment">#执行策略函数</span></span><br><span class="line">        value = context.cash <span class="comment">#股票和现金总价值</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">#计算当天的总价值</span></span><br><span class="line">        <span class="keyword">for</span> stock <span class="keyword">in</span> context.positions:</span><br><span class="line">            today_data = get_today_data(stock)          </span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">len</span>(today_data) == <span class="number">0</span>: <span class="comment">#停牌</span></span><br><span class="line">                p = last_price[stock]</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                p = today_data[<span class="string">&#x27;open&#x27;</span>]</span><br><span class="line">                last_price[stock] = p           </span><br><span class="line">            value += p * context.positions[stock] <span class="comment">#将持仓中所有股票的价值加到value里</span></span><br><span class="line">        plt_df.loc[dt, <span class="string">&#x27;value&#x27;</span>] = value <span class="comment">#将当天总的value赋值给plt_df</span></span><br><span class="line">    <span class="comment">#print(plt_df)</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">#计算收益率（与初始现金比较）</span></span><br><span class="line">    plt_df[<span class="string">&#x27;ratio&#x27;</span>] = (plt_df[<span class="string">&#x27;value&#x27;</span>] - init_value) / init_value</span><br><span class="line">    <span class="comment">#print(plt_df[&#x27;ratio&#x27;])</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">#计算基准股票的收益率</span></span><br><span class="line">    bm_df = attribute_daterange_history(context.benchmark, context.start_date, context.end_date) <span class="comment">#取基准股票同一时段的股价</span></span><br><span class="line">    bm_init = bm_df[<span class="string">&#x27;open&#x27;</span>][<span class="number">0</span>] <span class="comment">#基准股票的初始股价</span></span><br><span class="line">    plt_df[<span class="string">&#x27;benchmark_ratio&#x27;</span>] = (bm_df[<span class="string">&#x27;open&#x27;</span>] - bm_init) / bm_init</span><br><span class="line">    <span class="comment">#print(plt_df)</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">#画图</span></span><br><span class="line">    plt_df[[<span class="string">&#x27;ratio&#x27;</span>, <span class="string">&#x27;benchmark_ratio&#x27;</span>]].plot()</span><br><span class="line">    plt.show()</span><br></pre></td></tr></table></figure>



<h2 id="0x05-策略评价"><a href="#0x05-策略评价" class="headerlink" title="0x05 策略评价"></a>0x05 策略评价</h2><hr>
<h2 id="0x99-学习资料"><a href="#0x99-学习资料" class="headerlink" title="0x99 学习资料"></a>0x99 学习资料</h2><h4 id="（一）B站网课"><a href="#（一）B站网课" class="headerlink" title="（一）B站网课"></a>（一）B站网课</h4><ol>
<li><a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1i741147LS">清华计算机博士带你学-Python金融量化分析</a> </li>
<li>AQF</li>
<li>恶魔的蛇果</li>
</ol>
<h4 id="（二）聚宽"><a href="#（二）聚宽" class="headerlink" title="（二）聚宽"></a>（二）聚宽</h4><ol>
<li><a target="_blank" rel="noopener" href="https://www.joinquant.com/view/community/detail/8ec7aaaa899cf928550f89a104637f22">零基础量化交易课程</a></li>
<li><a target="_blank" rel="noopener" href="https://www.joinquant.com/help/api/help#name:api">聚宽API文档</a></li>
<li><a target="_blank" rel="noopener" href="https://www.joinquant.com/study">量化课堂</a></li>
<li><a target="_blank" rel="noopener" href="https://www.joinquant.com/view/community/list?listType=1">聚宽社区</a></li>
</ol>
<h4 id="（三）Github"><a href="#（三）Github" class="headerlink" title="（三）Github"></a>（三）Github</h4><h4 id="（四）其他"><a href="#（四）其他" class="headerlink" title="（四）其他"></a>（四）其他</h4><ol>
<li>vn.py</li>
<li>米筐</li>
<li>阿布量化</li>
</ol>
<h4 id="（五）文献"><a href="#（五）文献" class="headerlink" title="（五）文献"></a>（五）文献</h4><hr>
 
      <!-- reward -->
      
    </div>
    

    <!-- copyright -->
    
    <div class="declare">
      <ul class="post-copyright">
        <li>
          <i class="ri-copyright-line"></i>
          <strong>版权声明： </strong>
          
          本博客所有文章除特别声明外，著作权归作者所有。转载请注明出处！
          
        </li>
      </ul>
    </div>
    
    <footer class="article-footer">
       
<div class="share-btn">
      <span class="share-sns share-outer">
        <i class="ri-share-forward-line"></i>
        分享
      </span>
      <div class="share-wrap">
        <i class="arrow"></i>
        <div class="share-icons">
          
          <a class="weibo share-sns" href="javascript:;" data-type="weibo">
            <i class="ri-weibo-fill"></i>
          </a>
          <a class="weixin share-sns wxFab" href="javascript:;" data-type="weixin">
            <i class="ri-wechat-fill"></i>
          </a>
          <a class="qq share-sns" href="javascript:;" data-type="qq">
            <i class="ri-qq-fill"></i>
          </a>
          <a class="douban share-sns" href="javascript:;" data-type="douban">
            <i class="ri-douban-line"></i>
          </a>
          <!-- <a class="qzone share-sns" href="javascript:;" data-type="qzone">
            <i class="icon icon-qzone"></i>
          </a> -->
          
          <a class="facebook share-sns" href="javascript:;" data-type="facebook">
            <i class="ri-facebook-circle-fill"></i>
          </a>
          <a class="twitter share-sns" href="javascript:;" data-type="twitter">
            <i class="ri-twitter-fill"></i>
          </a>
          <a class="google share-sns" href="javascript:;" data-type="google">
            <i class="ri-google-fill"></i>
          </a>
        </div>
      </div>
</div>

<div class="wx-share-modal">
    <a class="modal-close" href="javascript:;"><i class="ri-close-circle-line"></i></a>
    <p>扫一扫，分享到微信</p>
    <div class="wx-qrcode">
      <img src="//api.qrserver.com/v1/create-qr-code/?size=150x150&data=http://example.com/2021/05/27/%E7%AE%97%E6%B3%95%E4%BA%A4%E6%98%93/" alt="微信分享二维码">
    </div>
</div>

<div id="share-mask"></div>  
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/quant/" rel="tag">quant</a></li></ul>

    </footer>
  </div>

   
  <nav class="article-nav">
    
      <a href="/2021/05/28/tushare-trade-cal-%E5%A4%B1%E6%95%88%E7%9A%84%E8%A7%A3%E5%86%B3%E6%96%B9%E6%B3%95/" class="article-nav-link">
        <strong class="article-nav-caption">上一篇</strong>
        <div class="article-nav-title">
          
            tushare.trade_cal()失效的解决方法
          
        </div>
      </a>
    
    
      <a href="/2021/05/26/%E6%8A%95%E8%B5%84%E7%9A%84%E4%B8%89%E4%B8%AA%E5%9F%BA%E6%9C%AC%E9%97%AE%E9%A2%98/" class="article-nav-link">
        <strong class="article-nav-caption">下一篇</strong>
        <div class="article-nav-title">投资的三个基本问题</div>
      </a>
    
  </nav>

   
<!-- valine评论 -->
<div id="vcomments-box">
  <div id="vcomments"></div>
</div>
<script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/valine@1.4.14/dist/Valine.min.js"></script>
<script>
  new Valine({
    el: "#vcomments",
    app_id: "ri8PwQqdewEXSAJRIYlg9Jsm-gzGzoHsz",
    app_key: "pj0jazzNF6pWStJ0nH4WLwkC",
    path: window.location.pathname,
    avatar: "",
    placeholder: "给我的文章加点评论吧~",
    recordIP: true,
  });
  const infoEle = document.querySelector("#vcomments .info");
  if (infoEle && infoEle.childNodes && infoEle.childNodes.length > 0) {
    infoEle.childNodes.forEach(function (item) {
      item.parentNode.removeChild(item);
    });
  }
</script>
<style>
  #vcomments-box {
    padding: 5px 30px;
  }

  @media screen and (max-width: 800px) {
    #vcomments-box {
      padding: 5px 0px;
    }
  }

  #vcomments-box #vcomments {
    background-color: #fff;
  }

  .v .vlist .vcard .vh {
    padding-right: 20px;
  }

  .v .vlist .vcard {
    padding-left: 10px;
  }
</style>

 
   
     
</article>

</section>
      <footer class="footer">
  <div class="outer">
    <ul>
      <li>
        Copyrights &copy;
        2021
        <i class="ri-heart-fill heart_icon"></i> Sandy Zhang
      </li>
    </ul>
    <ul>
      <li>
        
        
        
        由 <a href="https://hexo.io" target="_blank">Hexo</a> 强力驱动
        <span class="division">|</span>
        主题 - <a href="https://github.com/Shen-Yu/hexo-theme-ayer" target="_blank">Ayer</a>
        
      </li>
    </ul>
    <ul>
      <li>
        
        
        <span>
  <span><i class="ri-user-3-fill"></i>访问人数:<span id="busuanzi_value_site_uv"></span></span>
  <span class="division">|</span>
  <span><i class="ri-eye-fill"></i>浏览次数:<span id="busuanzi_value_page_pv"></span></span>
</span>
        
      </li>
    </ul>
    <ul>
      
    </ul>
    <ul>
      
    </ul>
    <ul>
      <li>
        <!-- cnzz统计 -->
        
        <script type="text/javascript" src='https://s9.cnzz.com/z_stat.php?id=1278069914&amp;web_id=1278069914'></script>
        
      </li>
    </ul>
  </div>
</footer>
      <div class="float_btns">
        <div class="totop" id="totop">
  <i class="ri-arrow-up-line"></i>
</div>

      </div>
    </main>
    <aside class="sidebar on">
      <button class="navbar-toggle"></button>
<nav class="navbar">
  
  <div class="logo">
    <a href="/"><img src="/images/ayer-side.svg" alt="Sandy&#39;s Blog"></a>
  </div>
  
  <ul class="nav nav-main">
    
    <li class="nav-item">
      <a class="nav-item-link" href="/">主页</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/categories">分类</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/about">关于</a>
    </li>
    
  </ul>
</nav>
<nav class="navbar navbar-bottom">
  <ul class="nav">
    <li class="nav-item">
      
      <a class="nav-item-link nav-item-search"  title="搜索">
        <i class="ri-search-line"></i>
      </a>
      
      
    </li>
  </ul>
</nav>
<div class="search-form-wrap">
  <div class="local-search local-search-plugin">
  <input type="search" id="local-search-input" class="local-search-input" placeholder="Search...">
  <div id="local-search-result" class="local-search-result"></div>
</div>
</div>
    </aside>
    <div id="mask"></div>

<!-- #reward -->
<div id="reward">
  <span class="close"><i class="ri-close-line"></i></span>
  <p class="reward-p"><i class="ri-cup-line"></i>请我喝杯咖啡吧~</p>
  <div class="reward-box">
    
    <div class="reward-item">
      <img class="reward-img" src="https://cdn.jsdelivr.net/gh/Shen-Yu/cdn/img/alipay.jpg">
      <span class="reward-type">支付宝</span>
    </div>
    
    
    <div class="reward-item">
      <img class="reward-img" src="https://cdn.jsdelivr.net/gh/Shen-Yu/cdn/img/wechat.jpg">
      <span class="reward-type">微信</span>
    </div>
    
  </div>
</div>
    
<script src="/js/jquery-2.0.3.min.js"></script>
 
<script src="/js/lazyload.min.js"></script>

<!-- Tocbot -->
 
<script src="/js/tocbot.min.js"></script>

<script>
  tocbot.init({
    tocSelector: ".tocbot",
    contentSelector: ".article-entry",
    headingSelector: "h1, h2, h3, h4, h5, h6",
    hasInnerContainers: true,
    scrollSmooth: true,
    scrollContainer: "main",
    positionFixedSelector: ".tocbot",
    positionFixedClass: "is-position-fixed",
    fixedSidebarOffset: "auto",
  });
</script>

<script src="https://cdn.jsdelivr.net/npm/jquery-modal@0.9.2/jquery.modal.min.js"></script>
<link
  rel="stylesheet"
  href="https://cdn.jsdelivr.net/npm/jquery-modal@0.9.2/jquery.modal.min.css"
/>
<script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/js/jquery.justifiedGallery.min.js"></script>

<script src="/dist/main.js"></script>

<!-- ImageViewer -->
 <!-- Root element of PhotoSwipe. Must have class pswp. -->
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    <!-- Background of PhotoSwipe. 
         It's a separate element as animating opacity is faster than rgba(). -->
    <div class="pswp__bg"></div>

    <!-- Slides wrapper with overflow:hidden. -->
    <div class="pswp__scroll-wrap">

        <!-- Container that holds slides. 
            PhotoSwipe keeps only 3 of them in the DOM to save memory.
            Don't modify these 3 pswp__item elements, data is added later on. -->
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                <!--  Controls are self-explanatory. Order can be changed. -->

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" style="display:none" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                <!-- Preloader demo http://codepen.io/dimsemenov/pen/yyBWoR -->
                <!-- element will get class pswp__preloader--active when preloader is running -->
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css">
<script src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js"></script>

<script>
    function viewer_init() {
        let pswpElement = document.querySelectorAll('.pswp')[0];
        let $imgArr = document.querySelectorAll(('.article-entry img:not(.reward-img)'))

        $imgArr.forEach(($em, i) => {
            $em.onclick = () => {
                // slider展开状态
                // todo: 这样不好，后面改成状态
                if (document.querySelector('.left-col.show')) return
                let items = []
                $imgArr.forEach(($em2, i2) => {
                    let img = $em2.getAttribute('data-idx', i2)
                    let src = $em2.getAttribute('data-target') || $em2.getAttribute('src')
                    let title = $em2.getAttribute('alt')
                    // 获得原图尺寸
                    const image = new Image()
                    image.src = src
                    items.push({
                        src: src,
                        w: image.width || $em2.width,
                        h: image.height || $em2.height,
                        title: title
                    })
                })
                var gallery = new PhotoSwipe(pswpElement, PhotoSwipeUI_Default, items, {
                    index: parseInt(i)
                });
                gallery.init()
            }
        })
    }
    viewer_init()
</script> 
<!-- MathJax -->
 <script type="text/x-mathjax-config">
  MathJax.Hub.Config({
      tex2jax: {
          inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
          processEscapes: true,
          skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
      }
  });

  MathJax.Hub.Queue(function() {
      var all = MathJax.Hub.getAllJax(), i;
      for(i=0; i < all.length; i += 1) {
          all[i].SourceElement().parentNode.className += ' has-jax';
      }
  });
</script>

<script src="https://cdn.jsdelivr.net/npm/mathjax@2.7.6/unpacked/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
<script>
  var ayerConfig = {
    mathjax: true,
  };
</script>

<!-- Katex -->

<!-- busuanzi  -->
 
<script src="/js/busuanzi-2.3.pure.min.js"></script>
 
<!-- ClickLove -->

<!-- ClickBoom1 -->

<script src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script>

<script src="/js/clickBoom1.js"></script>
 
<!-- ClickBoom2 -->

<!-- CodeCopy -->
 
<link rel="stylesheet" href="/css/clipboard.css">
 <script src="https://cdn.jsdelivr.net/npm/clipboard@2/dist/clipboard.min.js"></script>
<script>
  function wait(callback, seconds) {
    var timelag = null;
    timelag = window.setTimeout(callback, seconds);
  }
  !function (e, t, a) {
    var initCopyCode = function(){
      var copyHtml = '';
      copyHtml += '<button class="btn-copy" data-clipboard-snippet="">';
      copyHtml += '<i class="ri-file-copy-2-line"></i><span>COPY</span>';
      copyHtml += '</button>';
      $(".highlight .code pre").before(copyHtml);
      $(".article pre code").before(copyHtml);
      var clipboard = new ClipboardJS('.btn-copy', {
        target: function(trigger) {
          return trigger.nextElementSibling;
        }
      });
      clipboard.on('success', function(e) {
        let $btn = $(e.trigger);
        $btn.addClass('copied');
        let $icon = $($btn.find('i'));
        $icon.removeClass('ri-file-copy-2-line');
        $icon.addClass('ri-checkbox-circle-line');
        let $span = $($btn.find('span'));
        $span[0].innerText = 'COPIED';
        
        wait(function () { // 等待两秒钟后恢复
          $icon.removeClass('ri-checkbox-circle-line');
          $icon.addClass('ri-file-copy-2-line');
          $span[0].innerText = 'COPY';
        }, 2000);
      });
      clipboard.on('error', function(e) {
        e.clearSelection();
        let $btn = $(e.trigger);
        $btn.addClass('copy-failed');
        let $icon = $($btn.find('i'));
        $icon.removeClass('ri-file-copy-2-line');
        $icon.addClass('ri-time-line');
        let $span = $($btn.find('span'));
        $span[0].innerText = 'COPY FAILED';
        
        wait(function () { // 等待两秒钟后恢复
          $icon.removeClass('ri-time-line');
          $icon.addClass('ri-file-copy-2-line');
          $span[0].innerText = 'COPY';
        }, 2000);
      });
    }
    initCopyCode();
  }(window, document);
</script>
 
<!-- CanvasBackground -->
 
<script src="/js/dz.js"></script>
 
<script>
  if (window.mermaid) {
    mermaid.initialize({ theme: "forest" });
  }
</script>


    
  </div>
</body>

</html>